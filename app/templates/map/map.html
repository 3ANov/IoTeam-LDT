{% extends 'base.html' %}
{% load static %}

{% block extrahead %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css"
      type="text/css">
<style>
    .map {
        height: 580px;
        width: 100%;
    }
</style>
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
<link href="http://egiptest.mos.ru/jsapi/lib/ol-5.2.0.css" rel="stylesheet" type="text/css">
<link href="http://egiptest.mos.ru/jsapi/lib/ol-ext-3.0.1.css" rel="stylesheet" type="text/css">

<script src="http://egiptest.mos.ru/jsapi/lib/proj4-2.4.4.js"></script>
<script src="http://egiptest.mos.ru/jsapi/lib/ol-5.2.0.js"></script>
<script src="http://egiptest.mos.ru/jsapi/lib/ol-ext-3.0.1.js"></script>
<script src="http://egiptest.mos.ru/jsapi/dist/egip.js"></script>
{% endblock extrahead %}


{% block content %}
<div id="map" class="map"></div>
<script type="text/javascript">


    var example;
    (function (example) {

        var moscow = egip.layers.toMetric([37.6178, 55.7517]);
        var map = egip.layers.createMap({
            target: 'map',
            layers: [egip.layers.createTiles2GIS()],
            view: egip.layers.createView77({
                zoom: 9
            }),
        });

        //odh_features = [new ol.Feature(new ol.geom.Point([9000, 8000])), new ol.Feature(new ol.geom.Point([10000, 8000]))];

        var layer = egip.layers.createVectorLayer({
            id: 'polygons',
            type: 'random',
            source: egip.layers.createVectorSource({}),
            // style: new ol.style.Style({
            //     image: new ol.style.Circle({
            //         radius: 10,
            //         fill: new ol.style.Fill({
            //             color: egip.layers.mock.getRandomColor()
            //         })
            //     })
            // })
        });
        map.addLayer(layer);

     var odh_data_url = '{% url 'odh_record_dataset' %}';
        fetch(odh_data_url)
            .then(function (resp) {
                return resp.json();
            })
            .then(function (data) {
                //console.log(data)
                for (geom of data){
                    //console.log(geom['fields']['geometry_type']);
                    var class_str = "new ol.geom."+ geom['fields']['geometry_type']+"("+[JSON.parse(geom['fields']['coordinates'])] +")";
                    //console.log(class_str);
                    //var a = eval(class_str);
                    //console.log(a);
                    //console.log(new ol.Feature(new a(JSON.parse(geom['fields']['coordinates']))));
                    // console.log(new ol.geom.Point([10000, 10000]));
                    //console.log(geom['fields']['coordinates']);
                    //console.log(JSON.parse(geom['fields']['coordinates']));
                    // odh_features.push(new ol.Feature(eval(class_str)));
                    // console.log(new ol.geom.Point([10000, 10001]));
                    // odh_features.push(new ol.Feature(new ol.geom.Point([10000, 10000])));
                    console.log(egip.layers.getLayerById(map, 'polygons'));

                    egip.layers.getLayerById(map, 'polygons').getSource()
                        .addFeature(new ol.Feature(eval(class_str)));
                }
            });

    })(example || (example = {}));
</script>


{% endblock %}
